# å§¿æ€ä¼°è®¡å¤±è´¥é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ âœ… å·²è§£å†³

## âš ï¸ é—®é¢˜ç°è±¡

è¿è¡Œå‘½ä»¤ï¼š
```bash
python .\main.py --input .\input\images\1.jpg --target black-square --margin-pixels 20 --save_output .\output\images\1_out.jpg
```

é”™è¯¯ä¿¡æ¯ï¼š
```
[DEBUG] Pose rejected. rmse=606.85px, d_n=8.7mm (limits: rmse<=10px, 50<=d_n<=8000)
[HINT] æ£€æµ‹åˆ°æ–¹å—åƒç´ å°ºå¯¸ ~793pxï¼›è‹¥æ·±åº¦ ~500mmï¼Œå»ºè®® --marker-size-mm 312
```

## ğŸ” é—®é¢˜åˆ†æ

### åˆæ­¥è¯Šæ–­ï¼ˆè¯¯å¯¼ï¼‰
æœ€åˆä»¥ä¸ºæ˜¯ marker-size-mm å‚æ•°é”™è¯¯ï¼Œå› ä¸ºï¼š
- é‡æŠ•å½±è¯¯å·® rmse = 606.85pxï¼ˆé™åˆ¶ï¼šâ‰¤10pxï¼‰âš ï¸ **ä¸¥é‡è¶…æ ‡**
- æ·±åº¦ d_n = 8.7mmï¼ˆé™åˆ¶ï¼š50-8000mmï¼‰âš ï¸ **æ·±åº¦è¿‡å°**
- ç³»ç»Ÿæç¤ºï¼š`å»ºè®® --marker-size-mm 312`

### çœŸæ­£åŸå› ï¼š**OpenCV SOLVEPNP_IPPE_SQUARE æ–¹æ³•å¤±æ•ˆ** âš ï¸

é€šè¿‡æ·±åº¦è¯Šæ–­å‘ç°ï¼š
1. **ç‹¬ç«‹æµ‹è¯•æ˜¾ç¤º RMSE åªæœ‰ 6.52px**ï¼ˆå®Œå…¨æ­£å¸¸ï¼‰
2. **main.py ä¸­ RMSE å´æ˜¯ 606.85px**ï¼ˆå¼‚å¸¸ï¼‰
3. **æ ¹æœ¬åŸå› ï¼š`cv2.SOLVEPNP_IPPE_SQUARE` åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­è¿”å›äº†é”™è¯¯çš„è§£**

æµ‹è¯•ç»“æœå¯¹æ¯”ï¼š
```
æ–¹æ³•              RMSE        æ·±åº¦(mm)      çŠ¶æ€
IPPE_SQUARE      869.2px     155.9mm      âŒ å®Œå…¨é”™è¯¯
ITERATIVE        6.5px       501.8mm      âœ… æ­£ç¡®
EPNP             7.9px       497.8mm      âœ… æ­£ç¡®
SQPNP            6.6px       501.7mm      âœ… æ­£ç¡®
```

`IPPE_SQUARE` åº”è¯¥æ˜¯ä¸“é—¨ä¸ºæ­£æ–¹å½¢ä¼˜åŒ–çš„ç®—æ³•ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¤±æ•ˆï¼ˆå¯èƒ½æ˜¯é€è§†å˜æ¢è¿‡å¤§ã€è§’ç‚¹æ£€æµ‹è¯¯å·®ã€ç•¸å˜ç­‰å› ç´ ï¼‰ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ä»£ç ï¼šæ”¹è¿› `solve_pose` å‡½æ•°

åœ¨ `main.py` çš„ `solve_pose` å‡½æ•°ä¸­æ·»åŠ éªŒè¯æœºåˆ¶ï¼š

**ä¿®å¤å‰ï¼ˆæœ‰é—®é¢˜ï¼‰ï¼š**
```python
# ç›²ç›®ä½¿ç”¨ IPPE_SQUAREï¼Œå³ä½¿ç»“æœé”™è¯¯
if hasattr(cv2, 'SOLVEPNP_IPPE_SQUARE'):
    ok, rvec, tvec = cv2.solvePnP(points_3d, corners_2d, K, dist, flags=cv2.SOLVEPNP_IPPE_SQUARE)
```

**ä¿®å¤åï¼ˆå·²å®ç°ï¼‰ï¼š**
```python
# ä½¿ç”¨ IPPE_SQUAREï¼Œä½†éªŒè¯ç»“æœçš„åˆç†æ€§
if hasattr(cv2, 'SOLVEPNP_IPPE_SQUARE'):
    ok_ippe, rvec_ippe, tvec_ippe = cv2.solvePnP(points_3d, corners_2d, K, dist, flags=cv2.SOLVEPNP_IPPE_SQUARE)
    if ok_ippe:
        # è®¡ç®—é‡æŠ•å½±è¯¯å·®
        reproj, _ = cv2.projectPoints(points_3d, rvec_ippe, tvec_ippe, K, dist)
        reproj = reproj.reshape(-1, 2)
        rmse_ippe = float(np.sqrt(np.mean(np.sum((reproj - corners_2d)**2, axis=1))))
        
        # åªæœ‰å½“ RMSE < 50px æ—¶æ‰æ¥å—ç»“æœ
        if rmse_ippe < 50.0:
            rvec, tvec = rvec_ippe, tvec_ippe
            ok = True

# å¦‚æœ IPPE_SQUARE å¤±è´¥æˆ–ä¸å¯é ï¼Œä½¿ç”¨ ITERATIVE
if not ok:
    ok, rvec, tvec = cv2.solvePnP(points_3d, corners_2d, K, dist, flags=cv2.SOLVEPNP_ITERATIVE)
```

### ä¿®å¤åçš„ç»“æœ

```bash
python .\main.py --input .\input\images\1.jpg --target black-square --marker-size-mm 312 --margin-pixels 20 --save_output .\output\images\1_out_fixed.jpg
```

è¾“å‡ºï¼š
```
[DEBUG] Detected corners: [[ 202.  344.] [1016.  376.] [ 959. 1146.] [ 209. 1122.]]
ç›¸æœºåæ ‡ä¸‹çš„ä½å§¿:
tvec (mm): [-74.62  22.66 501.77]
rvec: [ 0.103 -0.036  0.042]
[DEBUG] Result saved to: .\output\images\1_out_fixed.jpg
```

- âœ… **RMSE = 6.52px**ï¼ˆç¬¦åˆ â‰¤10px çš„è¦æ±‚ï¼‰
- âœ… **æ·±åº¦ = 501.77mm**ï¼ˆåœ¨ 50-8000mm èŒƒå›´å†…ï¼‰
- âœ… **æ²¡æœ‰é”™è¯¯è­¦å‘Š**
- âœ… **å§¿æ€ä¼°è®¡æˆåŠŸ**

## ğŸ“Š å‚æ•°å»ºè®®

æ ¹æ®å®é™…æµ‹é‡çš„æ·±åº¦å’Œåƒç´ å°ºå¯¸å…³ç³»ï¼š

| å®é™…æ·±åº¦(mm) | å»ºè®® marker-size-mm |
|-------------|-------------------|
| 300         | 187               |
| 400         | 249               |
| 500         | 312               |
| 600         | 374               |
| 700         | 436               |
| 800         | 499               |

**æœ€ä½³åšæ³•**ï¼š
1. **æµ‹é‡æ–¹å—çš„å®é™…è¾¹é•¿**ï¼ˆç”¨å°ºå­æµ‹é‡ï¼Œå•ä½æ¯«ç±³ï¼‰
2. ä½¿ç”¨ `--marker-size-mm` å‚æ•°æŒ‡å®šå®é™…å°ºå¯¸

å¦‚æœæ–¹å—å°ºå¯¸æœªçŸ¥ä½†æ·±åº¦å·²çŸ¥ï¼ˆé€šè¿‡å…¶ä»–ä¼ æ„Ÿå™¨ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä¸Šè¡¨ä¼°ç®—ã€‚

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆ IPPE_SQUARE ä¼šå¤±è´¥ï¼Ÿ

1. **é€è§†å˜å½¢è¿‡å¤§**ï¼šæ–¹å—å€¾æ–œè§’åº¦å¤ªå¤§
2. **è§’ç‚¹æ£€æµ‹è¯¯å·®**ï¼šæ£€æµ‹åˆ°çš„è§’ç‚¹ä¸å¤Ÿç²¾ç¡®
3. **ç•¸å˜å½±å“**ï¼šç›¸æœºç•¸å˜è¾ƒå¤§ä½†æœªå……åˆ†æ ¡æ­£
4. **ç®—æ³•å±€é™æ€§**ï¼šIPPE_SQUARE å¯¹è¾“å…¥æ•°æ®è´¨é‡è¦æ±‚è¾ƒé«˜

### PnP ç®—æ³•é€‰æ‹©å»ºè®®

- **ITERATIVE**ï¼šæœ€ç¨³å®šï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼ˆæ¨èï¼‰
- **EPNP**ï¼šå¿«é€Ÿï¼Œç²¾åº¦ç¨ä½
- **SQPNP**ï¼šè¾ƒæ–°ç®—æ³•ï¼Œç²¾åº¦é«˜
- **IPPE_SQUARE**ï¼šä¸“ä¸ºæ­£æ–¹å½¢è®¾è®¡ï¼Œä½†éœ€è¦éªŒè¯ç»“æœ
- **P3P**ï¼šåªç”¨3ä¸ªç‚¹ï¼Œç²¾åº¦è¾ƒä½

## ğŸ“ æ€»ç»“

### é—®é¢˜æœ¬è´¨
ä¸æ˜¯ marker-size-mm å‚æ•°é”™è¯¯ï¼Œè€Œæ˜¯ **OpenCV çš„ SOLVEPNP_IPPE_SQUARE ç®—æ³•åœ¨ç‰¹å®šæ¡ä»¶ä¸‹å¤±æ•ˆ**ã€‚

### è§£å†³æ–¹æ³•
æ·»åŠ ç»“æœéªŒè¯æœºåˆ¶ï¼Œå½“ IPPE_SQUARE å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æ›´ç¨³å®šçš„ ITERATIVE æ–¹æ³•ã€‚

### ç»éªŒæ•™è®­
1. **ä¸è¦ç›²ç›®ä¿¡ä»»ç®—æ³•**ï¼šå³ä½¿æ˜¯ä¸“é—¨ä¼˜åŒ–çš„ç®—æ³•ä¹Ÿå¯èƒ½å¤±è´¥
2. **æ·»åŠ éªŒè¯æœºåˆ¶**ï¼šè®¡ç®—é‡æŠ•å½±è¯¯å·®éªŒè¯ç»“æœåˆç†æ€§
3. **æä¾›é™çº§æ–¹æ¡ˆ**ï¼šå‡†å¤‡å¤šä¸ªå¤‡é€‰ç®—æ³•
4. **æ·±å…¥è¯Šæ–­**ï¼šä¸è¦è¢«è¡¨é¢ç°è±¡è¯¯å¯¼ï¼Œè¦æ‰¾åˆ°æ ¹æœ¬åŸå› 

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ä¿®å¤åçš„ä»£ç ï¼š

```bash
# åŸºæœ¬ç”¨æ³•ï¼ˆä½¿ç”¨é»˜è®¤æˆ–æµ‹é‡çš„å°ºå¯¸ï¼‰
python main.py --input ./input/images/1.jpg --target black-square --marker-size-mm 124

# ä¿å­˜è¾“å‡º
python main.py --input ./input/images/1.jpg --target black-square --marker-size-mm 312 --save_output ./output/images/result.jpg

# å¤„ç†è§†é¢‘
python main.py --input ./input/videos/1.mp4 --target black-square --marker-size-mm 124 --save ./output/videos/result.mp4
```

ä¿®å¤å·²å®Œæˆï¼Œé—®é¢˜å·²è§£å†³ï¼âœ…

ğŸ“ æ€»ç»“
å‚æ•°	å«ä¹‰	å½“å‰å€¼	å•ä½
area	æ£€æµ‹åŒºåŸŸé¢ç§¯	604599	åƒç´ Â²
corners	å››ä¸ªè§’ç‚¹åæ ‡	[[202,344], ...]	åƒç´ 
tvec[0]	X æ–¹å‘ä½ç§»ï¼ˆå·¦å³ï¼‰	-29.65	mm
tvec[1]	Y æ–¹å‘ä½ç§»ï¼ˆä¸Šä¸‹ï¼‰	9.01	mm
tvec[2]	Z æ–¹å‘è·ç¦»ï¼ˆæ·±åº¦ï¼‰âš ï¸	199.42	mm
rvec	æ—‹è½¬å‘é‡ï¼ˆRodriguesï¼‰	[0.103, -0.036, 0.042]	å¼§åº¦


## è§†é¢‘å¤„ç†å¼‚å¸¸åŸå› 
æ‰€æœ‰ marker_size çš„ RMSE éƒ½æ˜¯ 29.78pxï¼ˆå®Œå…¨ç›¸åŒï¼ï¼‰
å³ä½¿å»é™¤ç•¸å˜ï¼ŒRMSE ä»ç„¶æ˜¯ 28.53pxï¼ˆå‡ ä¹æ²¡å˜ï¼‰
è§†é¢‘åˆ†è¾¨ç‡æ˜¯ 720x1280ï¼Œä¸æ ‡å®šçš„ 1279x1706 å·®å¼‚å¾ˆå¤§

ğŸ’¡ è§£å†³æ–¹æ¡ˆ
æ–¹æ¡ˆ 1ï¼šé‡æ–°æ ‡å®šç›¸æœºï¼ˆæ¨èï¼‰â­â­â­
ä½¿ç”¨ 720x1280 åˆ†è¾¨ç‡é‡æ–°æ ‡å®šç›¸æœºï¼š

ç”¨è¿™ä¸ªåˆ†è¾¨ç‡æ‹æ‘„æ£‹ç›˜æ ¼æ ‡å®šå›¾
è¿è¡Œæ ‡å®šè„šæœ¬ç”Ÿæˆæ–°çš„ calibration_results_720x1280.npz
ä½¿ç”¨ --intrinsics å‚æ•°æŒ‡å®šæ–°çš„æ ‡å®šæ–‡ä»¶
æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ— ç•¸å˜æ¨¡å¼ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰â­
è™½ç„¶æ•ˆæœä»ä¸ç†æƒ³ï¼ˆRMSE ~28pxï¼‰ï¼Œä½†æ¯”æœ‰ç•¸å˜ç¨å¥½ï¼š
python main.py --input ./input/videos/1.mp4 --target black-square --marker-size-mm 250 --no-dist --save ./output/videos/result_nodist.mp4